# FastAPI Template

## Developing

### Requirements

Latest version of [python](https://www.python.org/), [pip](https://pypi.org/project/pip/), and [PostgreSQL](https://www.postgresql.org/download/).

We recommend using [pyenv](https://github.com/pyenv/pyenv) for python version management, and [pgAdmin](https://www.pgadmin.org/download/) for a comprehensive development platform for PostgreSQL.

<br></br>

### Installing

Install FastAPI and all dependencies:

```bash
pip install -r requirements.txt
```

<details>
<summary>List of included dependencies</summary>

- fastapi
- pydantic
- email-validator
- SQLAlchemy
- psycopg2-binary
- alembic
- tenacity
- python-multipart
- python-jose[cryptography]
- passlib[bycript]
- sentry-sdk
</details>

#### Development Database

Database connection is setup to use environment variables in a `.env` file.
A `example.env` is provided that uses database and initial data variables for the following setup:

Development database creation using `trukem` with user `trukem` at `localhost:5432` :

```sql
CREATE DATABASE db_name;
```

```sql
CREATE USER user WITH SUPERUSER PASSWORD 'password';
```

_First time setup_ - Initialize database with migrations and establish first superuser:

```bash
./prestart.sh
```

This uses the FIRST_SUPERUSER and FIRST_SUPERUSER_PASSWORD variables as credentials to create an initial admin user, these can be changed in the `.env` file.

> **Note:** Remember to change any of the above database and initial data variables to fit your needs.

### Project Configuration

1. Copy the `.env.example` file to `.env` and update the variables to fit your environment.

2. Edit the project information in `app/api/config.py` to fit your project.

## Running in Development Mode

Before initiating the development mode, ensure that your `.env` file includes the necessary environment variables required for the application to run smoothly. Set the following variables within the `.env` file:

```plaintext
ENVIRONMENT=dev
```

### Environment Variables

- **ENVIRONMENT**: This variable specifies the environment the application will run in. For development purposes, set it to `dev`.

Ensure that these variables are correctly configured to enable seamless execution of the application in the development environment.

> **Note:** Setting the `ENVIRONMENT` env variable to `dev` ensures that when you are working with a shopify app in your local environment, the correct shopify_app_url variable is being used. In `dev`, settings.shopify_app_url will be used for callbacks. When not in `dev`, order.shopify_app_url will be used for callbacks.

---

## Starting the Api Server

To begin working with the API these steps:

### 1. Starting the Server:

```bash
uvicorn app.main:app --reload
```

- Explanation:
  - `uvicorn` is the tool used to run Python web apps.
  - `app.main:app` specifies the entry point of the API application.
  - The `--reload` flag enables automatic server reloading upon code changes.

### 2. Database Requirement:

- Ensure that the PostgreSQL database is up and running before starting the API server.

<br></br>

## Documentation

There are 2 options for using FastAPI's interactive api docs:

1. api documentation provided by Swagger UI http://127.0.0.1:8000/docs

2. api documentation provided by ReDoc http://127.0.0.1:8000/redoc

The schema is generated by OpenAPI and the raw JSON can be viewed at http://127.0.0.1:8000/openapi.json

<br></br>

### Alembic and Migration

#### Handling Alembic Migrations

When creating new models/schemas generate and update migrations with:

```bash
./generate-migration.sh
```

If just updating current migration to latest:

```bash
./update-migration.sh
```

Downgrade migrations:

```bash
alembic downgrade -[number of versions to downgrade]
```

#### Alembic Setup

This is only needed if setting up a new alembic environment

- init Alembic with: `alembic init alembic`

```python
# alembic/env.py
# add your model's MetaData object here
from fastapi.models import Base
target_metadata = Base.metadata
```

---

> **Note:** A "migration" is the set of steps needed whenever you change the structure of your SQLAlchemy models, add a new attribute, etc. to replicate those changes in the database, add a new column, a new table, etc.
